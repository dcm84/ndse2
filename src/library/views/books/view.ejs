<%- include("../partials/layout-start", {title: title}) %>
<%- include("../partials/menu") %>
<h1>
    <%= title %>
</h1>

<div class="row">
    <div class="col-sm-8">
        <div class="card">
            <div class="card-body">

                <h4 class="card-title">
                    <%= book.title %>
                </h4>

                <% if (book.description) { %>
                    <h6>Описание:</h6>
                    <p class="card-text">
                        <%= book.description %>
                    </p>
                <% } %>

                <% if (book.authors) { %>
                    <h6>Авторы:</h6>
                    <p class="card-text">
                        <%= book.authors %>
                    </p>
                <% } %>

                <% if (book.favorite) { %>
                    <p class="card-text">
                        <%= book.favorite %>
                    </p>
                <% } %>

                <% if (book.fileCover) { %>
                    <p class="card-text">
                        <img src="/<%= book.fileCover %>" width="50%"/>
                    </p>
                <% } %>

                <% if (book.fileBook) { %>
                    <a class="btn btn-sm btn-primary" href="/books/<%= book.id %>/download">
                        <i class="fa fa-book" aria-hidden="true"></i>
                        Скачать
                    </a>
                <% } %>

                <div class="text-right">
                    <a class="btn btn-sm btn-primary" href="/books/update/<%= book.id %>">
                        <i class="fa fa-pencil" aria-hidden="true"></i>
                    </a>
                    <form action="/books/delete/<%= book.id %>" method="POST" class="d-inline">
                        <button class="btn btn-sm btn-danger">
                            <i class="fa fa-trash" aria-hidden="true"></i>
                        </button>
                    </form>
                </div>

                <!-- немного обсуждений с помощью socket.io -->
                
                <script src="/socket.io/socket.io.js"></script>

                <div class="container">

                    <div class="row">
                        <div class="col-4">
                            <div id="list" class="list-group">
                                <% comments.map((el, idx) => { %>
                                    <div class="list-group-item list-group-item-action">
                                        <div class="d-flex w-100 justify-content-between">
                                            <small><%= el.userName %></small>
                                        </div>
                                        <p class="mb-1"><%= el.message %></p>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    </div>
                    
                    <% if (user) { %>
                    <div class="row">
                        <div class="col-4">
                            <div class="form-group">
                                <label for="userName">username</label>
                                <input placeholder="User Name" type="text" id="userName" class="form-control" value="<%= user.login %>" readonly>
                                <input type="hidden" id="userID" class="form-control" value="<%= user.id %>" readonly>
                            </div>
                            <div class="form-group">
                                <label for="message">Сообщение</label>
                                <textarea placeholder="message" class="form-control" id="message"></textarea>
                            </div>
                            <button type="submit" id="send-room" class="btn btn-primary">Отправить сообщение</button>
                        </div>
                    </div>
                    <% } else { %>
                        <p>Для того, чтобы писать сообщения, <a href="/user/login">авторизуйтесь</a></p>
                    <% } %>
                </div>

                <script>
                    const bookID = location.pathname.split('/').pop();
                    const socket = io.connect('/', {query: `bookID=${bookID}`});
                    
                    const boxList = document.querySelector('#list');
                    const inputUsername = document.querySelector('#userName');
                    const inputUserID = document.querySelector('#userID');
                    const inputMessage = document.querySelector('#message');

                    const sendRoom = document.querySelector('#send-room');

                    const formatMessage = (msg) => {
                        return `
                            <div class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <small>${
                                        msg.userName
                                    }</small>
                                </div>
                                <p class="mb-1">${
                                        msg.message
                                    }</p>
                            </div>`;
                    };

                    socket.on('message-to-room', (msg) => {
                        const div = formatMessage(msg);
                        boxList.insertAdjacentHTML('beforeend', div);
                    });

                    sendRoom.addEventListener('click', () => {
                        socket.emit('message-to-room', {
                            userName: inputUsername.value,
                            userID: inputUserID.value,
                            message: inputMessage.value
                        });
                    });
                </script>


            </div>
        </div>
        <div class="mt-2">
            <a class="btn btn-sm btn-primary" href="/books">Вернуться к списку книг</a>
        </div>


    </div>
</div>

<%- include("../partials/layout-end") %>
